<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Koii DOS</title>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }

      #dos {
        width: 100%;
        height: 100%;
      }
    </style>

    <!-- js-dos style sheet -->
    <link rel="stylesheet" href="./js-dos.css" />

    <!-- js-dos -->
    <script src="./js-dos.js"></script>
  </head>
  <body>
    <div id="dos"></div>

    <script>
      // Get taskId from URL
      function getTaskId() {
        const pathParts = window.location.pathname.split("/");
        const taskIndex = pathParts.indexOf("task");
        return taskIndex !== -1 && pathParts.length > taskIndex + 1
          ? pathParts[taskIndex + 1]
          : null;
      }

      // Function to securely send score to Koii task
      async function submitScore(score) {
        try {
          const taskId = getTaskId();
          if (!taskId) {
            throw new Error("No task ID found");
          }

          const timestamp = Date.now();
          const data = {
            score: score,
            timestamp: timestamp,
            gameState: "finished",
          };

          // Send score to backend
          const response = await fetch(`/task/${taskId}/submit-score`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });

          if (!response.ok) {
            throw new Error("Failed to submit score");
          }

          console.log("Score submitted successfully:", score);
        } catch (error) {
          console.error("Error submitting score:", error);
        }
      }

      window.onload = function () {
        const taskId = getTaskId();
        if (!taskId) {
          console.error("No task ID found in URL");
          return;
        }

        // Initialize game state
        fetch(`/task/${taskId}/init-game`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        }).catch((err) => console.error("Error initializing game:", err));

        // Initialize DOS emulator
        // Dos(document.getElementById("dos"), {
        //   url: "./bundle.jsdos",
        //   onEvent: (event, ci) => {
        //     console.log(event);
        //   },
        // });

        Dos(document.getElementById("dos"), {
          url: "./bundle.jsdos", // Path to the game
          onEvent: (event) => {
            console.log("Event received from js-dos:", event);

            // Handle any specific events
            if (event.type === "frame") {
              console.log("Frame updated");
            }
          },
        });
      };

      function getTextFromCanvas() {
        const canvas = document.querySelector("canvas");
        // Ensure the canvas exists
        if (canvas) {
          // Get the 2D drawing context
          const ctx = canvas.getContext("2d");

          console.log(ctx);

          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

          console.log(imageData);

          const data = imageData.data;

          let text = "";

          for (let i = 0; i < data.length; i += 4) {
            text += String.fromCharCode(data[i]);
          }
          console.log(text);
        }
        // const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        // const data = imageData.data;
        // let text = "";

        return "text";
      }

      setInterval(() => {
        const text = getTextFromCanvas();
        console.log(text);
      }, 1000);
    </script>
  </body>
</html>
